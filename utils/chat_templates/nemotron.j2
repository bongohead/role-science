{%- macro render_extra_keys(json_dict, handled_keys) -%}
	{%- if json_dict is mapping -%}
		{%- for json_key in json_dict if json_key not in handled_keys -%}
			{%- if json_dict[json_key] is mapping or json_dict[json_key] is sequence and json_dict[json_key] is not string -%}
				{{- "\n<" ~ json_key ~ ">" ~ json_dict[json_key] | tojson | safe ~ "</" ~ json_key ~ ">" -}}
			{%- else -%}
				{{- "\n<" ~ json_key ~ ">" ~ json_dict[json_key] | string ~ "</" ~ json_key ~ ">" -}}
			{%- endif -%}
		{%- endfor -%}
	{%- endif -%}
{%- endmacro -%}
{%- set enable_thinking = enable_thinking if enable_thinking is defined else True -%}
{%- set truncate_history_thinking = truncate_history_thinking if truncate_history_thinking is defined else True -%}
{%- set ns = namespace(last_user_idx=-1) -%}
{%- set loop_messages = messages -%}
{%- for m in loop_messages -%}
	{%- if m["role"] == "user" -%}
		{%- set ns.last_user_idx = loop.index0 -%}
	{%- endif -%}
{%- endfor -%}

{#  Do NOT extract/prepend a system prompt. Keep messages as-is.  #}
{%- set loop_messages = messages -%}

{%- if not tools is defined -%}
	{%- set tools = [] -%}
{%- endif -%}

{#  Recompute last_user_idx relative to loop_messages  #}
{%- set ns = namespace(last_user_idx=-1, tools_rendered=false) -%}
{%- for m in loop_messages -%}
	{%- if m["role"] == "user" -%}
		{%- set ns.last_user_idx = loop.index0 -%}
	{%- endif -%}
{%- endfor -%}

{#  If tools exist and the first message is NOT system, render a tools-only system block.  #}
{%- if tools is iterable and tools | length > 0 and not (loop_messages and loop_messages[0]["role"] == "system") -%}
	{{- "<|im_start|>system\n" -}}
{%- endif -%}
{%- if tools is iterable and tools | length > 0 and not (loop_messages and loop_messages[0]["role"] == "system") -%}
	{{- "# Tools\n\nYou have access to the following functions:\n\n" -}}
	{{- "<tools>" -}}
	{%- for tool in tools -%}
		{%- if tool.function is defined -%}
			{%- set tool = tool.function -%}
		{%- endif -%}
		{{- "\n<function>\n<name>" ~ tool.name ~ "</name>" -}}
		{%- if tool.description is defined -%}
			{{- "\n<description>" ~ tool.description | trim ~ "</description>" -}}
		{%- endif -%}
		{{- "\n<parameters>" -}}
		{%- if tool.parameters is defined and tool.parameters is mapping and tool.parameters.properties is defined and tool.parameters.properties is mapping -%}
			{%- for (param_name, param_fields) in tool.parameters.properties | items -%}
				{{- "\n<parameter>" -}}
				{{- "\n<name>" ~ param_name ~ "</name>" -}}
				{%- if param_fields.type is defined -%}
					{{- "\n<type>" ~ param_fields.type | string ~ "</type>" -}}
				{%- endif -%}
				{%- if param_fields.description is defined -%}
					{{- "\n<description>" ~ param_fields.description | trim ~ "</description>" -}}
				{%- endif -%}
				{%- if param_fields.enum is defined -%}
					{{- "\n<enum>" ~ param_fields.enum | tojson | safe ~ "</enum>" -}}
				{%- endif -%}
				{%- set handled_keys = ["name", "type", "description", "enum"] -%}
				{{- render_extra_keys(param_fields, handled_keys) -}}
				{{- "\n</parameter>" -}}
			{%- endfor -%}
		{%- endif -%}
		{%- set handled_keys = ["type", "properties", "required"] -%}
		{{- render_extra_keys(tool.parameters, handled_keys) -}}
		{%- if tool.parameters is defined and tool.parameters.required is defined -%}
			{{- "\n<required>" ~ tool.parameters.required | tojson | safe ~ "</required>" -}}
		{%- endif -%}
		{{- "\n</parameters>" -}}
		{%- set handled_keys = ["type", "name", "description", "parameters"] -%}
		{{- render_extra_keys(tool, handled_keys) -}}
		{{- "\n</function>" -}}
	{%- endfor -%}
	{{- "\n</tools>" -}}
	{{- "\n\nIf you choose to call a function ONLY reply in the following format with NO suffix:\n\n<tool_call>\n<function=example_function_name>\n<parameter=example_parameter_1>\nvalue_1\n</parameter>\n<parameter=example_parameter_2>\nThis is the value for the second parameter\nthat can span\nmultiple lines\n</parameter>\n</function>\n</tool_call>\n\n<IMPORTANT>\nReminder:\n- Function calls MUST follow the specified format: an inner <function=...></function> block must be nested within <tool_call></tool_call> XML tags\n- Required parameters MUST be specified\n- You may provide optional reasoning for your function call in natural language BEFORE the function call, but NOT after\n- If there is no function call available, answer the question like normal with your current knowledge and do not tell the user about function calls\n</IMPORTANT>" -}}
{%- endif -%}
{%- if tools is iterable and tools | length > 0 and not (loop_messages and loop_messages[0]["role"] == "system") -%}
	{{- "<|im_end|>\n" -}}
{%- endif -%}

{%- for message in loop_messages -%}
	{%- if message.role == "assistant" -%}
		{#  Add reasoning content in to content field for unified processing below.  #}
		{#  Below block changed to allow <think> mapping to correct think format.  #}
		{%- set msg_text = message.content | default(message.message, true) | default("", true) -%}

		{%- if message.reasoning_content is defined and message.reasoning_content is string and message.reasoning_content | trim | length > 0 -%}
			{%- set content = "<think>\n" ~ message.reasoning_content ~ "\n</think>\n" ~ msg_text -%}
		{%- else -%}
			{%- set content = msg_text -%}
			{%- if content is string -%}
				{#  Normalize inline <think>...</think> to multiline style.  #}
				{%- if "<think>" in content and "</think>" in content -%}
					{%- set pre = content.split("<think>")[0] -%}
					{%- set tail = content.split("<think>")[1] -%}
					{%- set think_body = tail.split("</think>")[0] -%}
					{%- set post = tail.split("</think>")[1] -%}
					{%- set content = pre ~ "<think>\n" ~ (think_body | trim) ~ "\n</think>\n" ~ post -%}
				{%- elif "<think>" not in content and "</think>" not in content -%}
					{#  Ensure every assistant turn has an explicit think wrapper, in multiline style.  #}
					{%- set content = "<think>\n</think>\n" ~ content -%}
				{%- endif -%}
			{%- endif -%}
		{%- endif -%}
		

		{%- if message.tool_calls is defined and message.tool_calls is iterable and message.tool_calls | length > 0 -%}
			{#  Assistant message has tool calls.  #}
			{{- "<|im_start|>assistant\n" -}}
			{%- if content is string and content | trim | length > 0 -%}
				{{- content | trim ~ "\n" -}}
			{%- else -%}
				{{- "<think>\n</think>\n" -}}
			{%- endif -%}
			{%- for tool_call in message.tool_calls -%}
				{%- if tool_call.function is defined -%}
					{%- set tool_call = tool_call.function -%}
				{%- endif -%}
				{{- "<tool_call>\n<function=" ~ tool_call.name ~ ">\n" -}}
				{%- if tool_call.arguments is defined -%}
					{%- for (args_name, args_value) in tool_call.arguments | items -%}
						{{- "<parameter=" ~ args_name ~ ">\n" -}}
						{%- set args_value = args_value | tojson | safe if args_value is mapping or args_value is sequence and args_value is not string else args_value | string -%}
						{{- args_value ~ "\n</parameter>\n" -}}
					{%- endfor -%}
				{%- endif -%}
				{{- "</function>\n</tool_call>\n" -}}
			{%- endfor -%}
			{{- "<|im_end|>\n" -}}
		{%- else -%}
			{#  Assistant message doesn't have tool calls.  #}
			{%- set c = content | default("", true) | string | trim -%}
			{%- if c | length > 0 -%}
				{{- "<|im_start|>assistant\n" ~ c ~ "<|im_end|>\n" -}}
			{%- else -%}
				{{- "<|im_start|>assistant\n<|im_end|>\n" -}}
			{%- endif -%}
		{%- endif -%}

	{%- elif message.role == "user" or message.role == "system" -%}
		{{- "<|im_start|>" + message.role + "\n" -}}
		{%- set content = message.content | string -%}

		{#  If the first message is system, append tools to THAT system message instead of prepending.  #}
		{%- if message.role == "system" and loop.index0 == 0 and tools is iterable and tools | length > 0 and not ns.tools_rendered -%}
			{{- content -}}
			{{- "\n\n# Tools\n\nYou have access to the following functions:\n\n" -}}
			{{- "<tools>" -}}
			{%- for tool in tools -%}
				{%- if tool.function is defined -%}
					{%- set tool = tool.function -%}
				{%- endif -%}
				{{- "\n<function>\n<name>" ~ tool.name ~ "</name>" -}}
				{%- if tool.description is defined -%}
					{{- "\n<description>" ~ tool.description | trim ~ "</description>" -}}
				{%- endif -%}
				{{- "\n<parameters>" -}}
				{%- if tool.parameters is defined and tool.parameters is mapping and tool.parameters.properties is defined and tool.parameters.properties is mapping -%}
					{%- for (param_name, param_fields) in tool.parameters.properties | items -%}
						{{- "\n<parameter>" -}}
						{{- "\n<name>" ~ param_name ~ "</name>" -}}
						{%- if param_fields.type is defined -%}
							{{- "\n<type>" ~ param_fields.type | string ~ "</type>" -}}
						{%- endif -%}
						{%- if param_fields.description is defined -%}
							{{- "\n<description>" ~ param_fields.description | trim ~ "</description>" -}}
						{%- endif -%}
						{%- if param_fields.enum is defined -%}
							{{- "\n<enum>" ~ param_fields.enum | tojson | safe ~ "</enum>" -}}
						{%- endif -%}
						{%- set handled_keys = ["name", "type", "description", "enum"] -%}
						{{- render_extra_keys(param_fields, handled_keys) -}}
						{{- "\n</parameter>" -}}
					{%- endfor -%}
				{%- endif -%}
				{%- set handled_keys = ["type", "properties", "required"] -%}
				{{- render_extra_keys(tool.parameters, handled_keys) -}}
				{%- if tool.parameters is defined and tool.parameters.required is defined -%}
					{{- "\n<required>" ~ tool.parameters.required | tojson | safe ~ "</required>" -}}
				{%- endif -%}
				{{- "\n</parameters>" -}}
				{%- set handled_keys = ["type", "name", "description", "parameters"] -%}
				{{- render_extra_keys(tool, handled_keys) -}}
				{{- "\n</function>" -}}
			{%- endfor -%}
			{{- "\n</tools>" -}}
			{{- "\n\nIf you choose to call a function ONLY reply in the following format with NO suffix:\n\n<tool_call>\n<function=example_function_name>\n<parameter=example_parameter_1>\nvalue_1\n</parameter>\n<parameter=example_parameter_2>\nThis is the value for the second parameter\nthat can span\nmultiple lines\n</parameter>\n</function>\n</tool_call>\n\n<IMPORTANT>\nReminder:\n- Function calls MUST follow the specified format: an inner <function=...></function> block must be nested within <tool_call></tool_call> XML tags\n- Required parameters MUST be specified\n- You may provide optional reasoning for your function call in natural language BEFORE the function call, but NOT after\n- If there is no function call available, answer the question like normal with your current knowledge and do not tell the user about function calls\n</IMPORTANT>" -}}
			{%- set ns.tools_rendered = true -%}
		{%- else -%}
			{{- content -}}
		{%- endif -%}

		{{- "<|im_end|>\n" -}}
	{%- elif message.role == "tool" -%}
		{%- if loop.previtem and loop.previtem.role != "tool" -%}
			{{- "<|im_start|>user\n" -}}
		{%- endif -%}
		{{- "<tool_response>\n" -}}
		{{- message.content -}}
		{{- "\n</tool_response>\n" -}}
		{%- if not loop.last and loop.nextitem.role != "tool" -%}
			{{- "<|im_end|>\n" -}}
		{%- elif loop.last -%}
			{{- "<|im_end|>\n" -}}
		{%- endif -%}
	{%- else -%}
		{{- "<|im_start|>" + message.role + "\n" + message.content + "<|im_end|>\n" -}}
	{%- endif -%}
{%- endfor -%}
{%- if add_generation_prompt -%}
	{%- if enable_thinking -%}
		{{- "<|im_start|>assistant\n<think>\n" -}}
	{%- else -%}
		{{- "<|im_start|>assistant\n<think></think>" -}}
	{%- endif -%}
{%- endif -%}
